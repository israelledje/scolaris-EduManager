{% load widget_tweaks %}
<div>
    <div class="mb-4">
        <div class="text-lg font-bold text-slate-900 flex items-center gap-2">
            <i class="fas fa-chalkboard-teacher text-indigo-600"></i>
            {{ context_title }}
        </div>
        <div class="text-slate-500 text-sm mt-1">{{ context_info }}</div>
    </div>
    <form method="post" class="space-y-6" id="teaching-assignment-form" action="{{ request.path }}">
        {% csrf_token %}
        
        <!-- Champs cachés pour la classe et l'année -->
        {{ form.school_class }}
        {{ form.year }}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="id_subject" class="block text-slate-700 font-medium mb-1">Matière<span class="text-red-500">*</span></label>
                {{ form.subject|add_class:'w-full border border-slate-300 rounded-lg px-3 py-2' }}
                <div class="text-red-600 text-xs mt-1">{{ form.subject.errors|join:', ' }}</div>
            </div>
            <div>
                <label for="id_teacher" class="block text-slate-700 font-medium mb-1">Enseignant<span class="text-red-500">*</span></label>
                {{ form.teacher|add_class:'w-full border border-slate-300 rounded-lg px-3 py-2' }}
                <div class="text-red-600 text-xs mt-1">{{ form.teacher.errors|join:', ' }}</div>
            </div>
            <div>
                <label for="id_coefficient" class="block text-slate-700 font-medium mb-1">Coefficient<span class="text-red-500">*</span></label>
                {{ form.coefficient|add_class:'w-full border border-slate-300 rounded-lg px-3 py-2' }}
                <div class="text-red-600 text-xs mt-1">{{ form.coefficient.errors|join:', ' }}</div>
            </div>
            <div>
                <label for="id_hours_per_week" class="block text-slate-700 font-medium mb-1">Heures/semaine<span class="text-red-500">*</span></label>
                {{ form.hours_per_week|add_class:'w-full border border-slate-300 rounded-lg px-3 py-2' }}
                <div class="text-red-600 text-xs mt-1">{{ form.hours_per_week.errors|join:', ' }}</div>
            </div>
            <div class="md:col-span-2 flex items-center gap-2 mt-2">
                {{ form.is_titulaire }}
                <label for="id_is_titulaire" class="text-slate-700 font-medium">Professeur titulaire</label>
            </div>
        </div>
        
        <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-100 mt-6">
            <button type="button" onclick="closeAssignmentModal()" class="px-4 py-2 text-slate-700 hover:bg-slate-200 rounded-xl transition-colors duration-200">Annuler</button>
            <button type="submit" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center">
                <span class="btn-text">Enregistrer</span>
                <i class="fas fa-spinner fa-spin hidden loading-spinner ml-2"></i>
            </button>
        </div>
    </form>
</div>
<script>
// 07/07/2025 - Filtrage dynamique des enseignants selon la matière
const subjectField = document.getElementById('id_subject');
const teacherField = document.getElementById('id_teacher');
if(subjectField && teacherField) {
    subjectField.addEventListener('change', function() {
        const subjectId = this.value;
        const classId = {{ school_class.id }};
        if (subjectId) {
            fetch(`/teachers/assignment/teacher-select/?subject_id=${subjectId}&class_id=${classId}`)
                .then(response => response.text())
                .then(html => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const newSelect = tempDiv.querySelector('select');
                    if(newSelect) {
                        teacherField.innerHTML = '';
                        Array.from(newSelect.options).forEach(opt => teacherField.appendChild(opt));
                    }
                });
        }
    });
}

// Gestion de la soumission du formulaire
document.getElementById('teaching-assignment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const btnText = submitBtn.querySelector('.btn-text');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    // Afficher le spinner
    btnText.textContent = 'Enregistrement...';
    spinner.classList.remove('hidden');
    submitBtn.disabled = true;
    
    // Récupérer les données du formulaire
    const formData = new FormData(form);
    
    // Soumettre via fetch
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.status === 204) {
            // Succès - recharger la page pour voir les changements
            window.location.reload();
        } else {
            return response.text();
        }
    })
    .then(html => {
        if (html) {
            // Erreur - afficher le formulaire avec les erreurs
            document.getElementById('modal-assignment-content').innerHTML = html;
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de la soumission du formulaire.');
    });
});
</script> 