{% extends "base.html" %}
{% load static %}

{% block page_title %}Liste des enseignants{% endblock %}

{% block page_actions %}
<div class="flex items-center gap-3">
    <button class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors duration-200">
        <i class="fas fa-download text-slate-500"></i>
        <span class="text-slate-700 font-medium">Exporter</span>
    </button>
    <button class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors duration-200">
        <i class="fas fa-upload text-slate-500"></i>
        <span class="text-slate-700 font-medium">Importer</span>
    </button>
    <button 
        hx-get="{% url 'teachers:teacher_create_htmx' %}"
        hx-target="#modal-content"
        hx-trigger="click"
        hx-swap="innerHTML"
        type="button"
        class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl"
    >
        <i class="fas fa-plus"></i>
        <span class="font-medium">Ajouter un enseignant</span>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Search and Filter Bar -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200/60 p-6 mb-6">
        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
            <!-- Search Bar -->
            <div class="flex-1 max-w-md">
                <form method="get" class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-400"></i>
                    </div>
                    <input
                        type="text"
                        name="search"
                        value="{{ request.GET.search|default:'' }}"
                        class="w-full pl-11 pr-4 py-3 border border-slate-200 rounded-xl bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 placeholder-slate-400"
                        placeholder="Rechercher par nom, prénom ou matricule..."
                    />
                </form>
            </div>
            <!-- Filtres matières -->
            <div class="flex flex-wrap gap-3">
                <div class="relative">
                    <button id="subjectFilterBtn" type="button" class="flex items-center gap-2 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 transition-colors duration-200 min-w-32">
                        <i class="fas fa-book text-slate-500"></i>
                        <span class="text-slate-700 font-medium">Matière</span>
                        <i class="fas fa-chevron-down text-slate-400 text-sm transition-transform duration-200"></i>
                    </button>
                    <div id="subjectFilterMenu" class="absolute top-full left-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-slate-200 py-2 z-10 hidden">
                        <a href="?subject=all" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 transition-colors duration-200">
                            <i class="fas fa-list mr-2 text-slate-400"></i>
                            Toutes les matières
                        </a>
                        {% for subject in subjects %}
                        <a href="?subject={{ subject.id }}" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 transition-colors duration-200">
                            <i class="fas fa-book mr-2 text-slate-400"></i>
                            {{ subject.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                <button onclick="resetTeacherFilters()" class="flex items-center gap-2 px-4 py-3 bg-slate-100 hover:bg-slate-200 rounded-xl transition-colors duration-200">
                    <i class="fas fa-undo text-slate-500"></i>
                    <span class="text-slate-700 font-medium">Reset</span>
                </button>
            </div>
        </div>
    </div>
    <!-- Teachers Table -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900">Enseignants</h3>
                    <p class="text-sm text-slate-500">{{ teachers|length }} enseignant{{ teachers|length|pluralize }} au total</p>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full" id="teachersTable">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Matricule</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nom</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Prénom</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Téléphone</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Matière principale</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Autres matières</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Classe titulaire</th>
                        <th class="px-6 py-4 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-200" id="teachersTableBody">
                    {% for teacher in teachers %}
                    <tr class="hover:bg-slate-50 transition-colors duration-200 teacher-row">
                        <td class="px-6 py-4 whitespace-nowrap font-mono">{{ teacher.matricule }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ teacher.last_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ teacher.first_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ teacher.phone|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ teacher.main_subject|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% for subject in teacher.subjects.all %}
                                <span class="inline-block bg-indigo-100 text-indigo-700 rounded px-2 py-1 text-xs mr-1 mb-1">{{ subject.name }}</span>
                            {% empty %}
                                <span class="text-slate-400">Aucune</span>
                            {% endfor %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if teacher.titular_classes.all %}
                                {% for classe in teacher.titular_classes.all %}
                                    <span class="inline-block bg-emerald-100 text-emerald-700 rounded px-2 py-1 text-xs mr-1 mb-1">{{ classe.name }}</span>
                                {% empty %}
                                    <span class="text-slate-400">Aucune</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-slate-400">Aucune</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <div class="flex items-center justify-end gap-2">
                                <a href="{% url 'teachers:teacher_detail' teacher.id %}"
                                   class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-200"
                                   title="Voir la fiche">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button 
                                    hx-get="{% url 'teachers:teacher_update_htmx' teacher.id %}"
                                    hx-target="#modal-content"
                                    hx-trigger="click"
                                    hx-swap="innerHTML"
                                    type="button"
                                    class="p-2 text-slate-400 hover:text-amber-600 hover:bg-amber-50 rounded-lg transition-all duration-200" 
                                    title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button 
                                    hx-get="{% url 'teachers:teacher_delete_htmx' teacher.id %}"
                                    hx-target="#modal-content"
                                    hx-trigger="click"
                                    hx-swap="innerHTML"
                                    type="button"
                                    class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200" 
                                    title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-user-tie text-2xl text-slate-400"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-slate-900 mb-2">Aucun enseignant trouvé</h3>
                                <p class="text-slate-500 text-sm mb-4">Commencez par ajouter votre premier enseignant</p>
                                <button 
                                    hx-get="{% url 'teachers:teacher_create_htmx' %}"
                                    hx-target="#modal-content"
                                    hx-trigger="click"
                                    hx-swap="innerHTML"
                                    type="button"
                                    class="px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors duration-200">
                                    <i class="fas fa-plus mr-2"></i>
                                    Ajouter un enseignant
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Modal universelle pour CRUD enseignant -->
<div id="modal-overlay" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center">
    <div id="modal-content" class="bg-white rounded-none sm:rounded-2xl shadow-xl p-4 sm:p-6 w-full max-w-2xl">
        <!-- Le contenu du formulaire sera chargé ici dynamiquement -->
    </div>
</div>

<!-- Toast notifications -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
function openModal() {
    document.getElementById('modal-overlay').classList.remove('hidden');
}
function closeModal() {
    document.getElementById('modal-overlay').classList.add('hidden');
}
document.getElementById('modal-overlay').addEventListener('click', function(event) {
    if (event.target === this) closeModal();
});
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') closeModal();
});

// --- Toast ---
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `px-4 py-3 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 translate-x-full ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
    toast.innerHTML = `<div class="flex items-center gap-2"><i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}-circle"></i><span>${message}</span></div>`;
    document.getElementById('toastContainer').appendChild(toast);
    setTimeout(() => { toast.classList.remove('translate-x-full'); }, 100);
    setTimeout(() => { toast.classList.add('translate-x-full'); setTimeout(() => toast.remove(), 300); }, 3000);
}

// --- Gestion du retour HTMX ---
document.body.addEventListener('htmx:afterOnLoad', function(evt) {
    if (evt.detail.xhr && evt.detail.xhr.responseType === '' && evt.detail.xhr.responseText) {
        try {
            const data = JSON.parse(evt.detail.xhr.responseText);
            if (data.success) {
                showToast(data.message || 'Succès', 'success');
                closeModal();
                setTimeout(() => { window.location.reload(); }, 1000);
            }
        } catch (e) { 
            // Ce n'est pas du JSON, donc c'est du HTML de formulaire - on garde la modale ouverte
        }
    }
});

// --- Fonctions de filtrage ---
function filterTeachers() {
    const searchTerm = document.querySelector('input[name="search"]').value.toLowerCase();
    const rows = document.querySelectorAll('.teacher-row');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function resetTeacherFilters() {
    document.querySelector('input[name="search"]').value = '';
    filterTeachers();
}

// --- Menu matières natif ---
const subjectBtn = document.getElementById('subjectFilterBtn');
const subjectMenu = document.getElementById('subjectFilterMenu');
if(subjectBtn && subjectMenu) {
    subjectBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        subjectMenu.classList.toggle('hidden');
    });
    document.addEventListener('click', function(e) {
        if (!subjectMenu.contains(e.target) && e.target !== subjectBtn) {
            subjectMenu.classList.add('hidden');
        }
    });
}

document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target && evt.detail.target.id === 'modal-content') {
        document.getElementById('modal-overlay').classList.remove('hidden');
    }
});
</script>

{% if toast %}
<script>
    showToast("{{ toast.message|escapejs }}", "{{ toast.type|default:'success' }}");
</script>
{% endif %}
{% endblock %}
